# CrecheBooks Environment Configuration
NODE_ENV=development
PORT=3000

# REQUIRED: Encryption Key for sensitive data (API tokens, credentials, PII)
# Generate with: openssl rand -base64 32
# SECURITY: This key MUST be at least 32 characters and kept secret
# WARNING: Application will fail to start without this key
ENCRYPTION_KEY=

# Database (PostgreSQL)
DATABASE_URL=postgresql://user:password@localhost:5432/crechebooks?schema=public

# Redis (REQUIRED for distributed features)
# CRITICAL: Redis is REQUIRED for CSRF token storage in distributed environments.
# Application will FAIL TO START if Redis is unavailable.
REDIS_HOST=localhost
REDIS_PORT=6379
# REDIS_PASSWORD=  # Optional: Uncomment if Redis requires authentication

# ======================================================================
# CSRF Protection Configuration (TASK-SEC-003)
# CSRF tokens are stored in Redis for distributed environment support.
# This ensures tokens generated by one API instance can be validated by another.
# ======================================================================
#
# KEY PATTERNS:
#   - OAuth state tokens: csrf:state:{stateToken} (TTL: 5 minutes)
#   - User-bound tokens:  csrf:user:{userId}:{tokenHashPrefix} (TTL: 1 hour)
#
# SECURITY NOTES:
#   - Tokens are hashed (SHA-256) before storage - never stored in plaintext
#   - Constant-time comparison (crypto.timingSafeEqual) prevents timing attacks
#   - Automatic expiration via Redis TTL
#   - Fail-secure: operations fail if Redis unavailable (no in-memory fallback)
#
# Default TTL values (can be configured in code if needed):
#   - CSRF_USER_TOKEN_TTL=3600      # 1 hour for user-bound tokens
#   - CSRF_OAUTH_STATE_TTL=300      # 5 minutes for OAuth state tokens

# ======================================================================
# JWT Configuration
# Required when DEV_AUTH_ENABLED=true
# ======================================================================
# SECURITY: Use a strong random string of at least 32 characters
# Generate with: openssl rand -base64 32
JWT_SECRET=
JWT_EXPIRATION=86400

# ======================================================================
# Development Authentication (TASK-SEC-001)
# SECURITY CRITICAL: ONLY for local development - NEVER enable in production
# ======================================================================
# When true, allows login via /api/v1/auth/dev-login endpoint
#
# FAIL-FAST VALIDATION - Application will FAIL TO START if:
#   - DEV_AUTH_ENABLED=true but no dev users configured
#   - DEV_AUTH_ENABLED=true in production (NODE_ENV=production)
#   - Password hash is not a valid bcrypt hash (must start with $2)
#   - DEV_USER_1_NAME or DEV_USER_1_ROLE is missing
#
# SECURITY NOTES (TASK-SEC-001):
#   - NEVER store plain text passwords in this file or source code
#   - ALWAYS use bcrypt hashes for DEV_USER_*_PASSWORD_HASH
#   - Password comparison uses bcrypt.compare (timing-safe)
#   - Rate limiting is applied to dev-login endpoint
DEV_AUTH_ENABLED=false

# Dev User 1 - Required when DEV_AUTH_ENABLED=true
# SECURITY: Password must be a bcrypt hash (starts with $2), NEVER plain text
#
# Generate bcrypt hash using one of these methods:
#   1. npx bcrypt-cli hash "your_secure_password" 10
#   2. node -e "console.log(require('bcrypt').hashSync('your_password', 10))"
#   3. Online: https://bcrypt-generator.com (use cost factor 10+)
#
# Valid roles: OWNER, ADMIN, STAFF, VIEWER
DEV_USER_1_EMAIL=
DEV_USER_1_PASSWORD_HASH=
DEV_USER_1_NAME=
DEV_USER_1_ROLE=

# Dev User 2 (Optional additional user - same security requirements)
# DEV_USER_2_EMAIL=
# DEV_USER_2_PASSWORD_HASH=
# DEV_USER_2_NAME=
# DEV_USER_2_ROLE=

# ======================================================================
# E2E Test Credentials (for Playwright tests)
# Must match a configured dev user when running E2E tests
# WARNING: These are plain text passwords for test automation only
# ======================================================================
E2E_TEST_EMAIL=
E2E_TEST_PASSWORD=

# Auth0 (for production use)
AUTH0_DOMAIN=
AUTH0_CLIENT_ID=
AUTH0_CLIENT_SECRET=
AUTH0_AUDIENCE=

# ======================================================================
# Xero Integration Configuration
# ======================================================================

# Xero OAuth Application Credentials
# Register at: https://developer.xero.com/
XERO_CLIENT_ID=
XERO_CLIENT_SECRET=
XERO_REDIRECT_URI=http://localhost:3001/api/v1/xero/callback

# REQUIRED: OAuth State Encryption Key (TASK-INT-002)
# Used to encrypt/decrypt OAuth state parameter to prevent CSRF attacks
# SECURITY: This key MUST be at least 32 characters and kept secret
# Generate with: openssl rand -base64 32
# WARNING: Xero integration will FAIL TO START without this key
XERO_STATE_KEY=

# Token Encryption Key (for storing Xero access tokens securely)
# Generate with: openssl rand -base64 32
TOKEN_ENCRYPTION_KEY=

# LLMWhisperer PDF Extraction Service
LLMWHISPERER_API_KEY=your_llmwhisperer_api_key_here
LLMWHISPERER_KEY_ID=your_llmwhisperer_key_id_here
LLMWHISPERER_BASE_URL=https://llmwhisperer-api.us-central.unstract.com

# ======================================================================
# Email Configuration - Mailgun (TASK-BILL-013, TASK-STAFF-001)
# Register at: https://app.mailgun.com/
# ======================================================================

# REQUIRED: Mailgun API Key (from Mailgun Dashboard > API Security)
MAILGUN_API_KEY=your_mailgun_api_key_here

# REQUIRED: Mailgun Domain (sandbox domain for testing, custom domain for production)
# Sandbox: sandbox{id}.mailgun.org
# Production: mail.yourdomain.com (requires DNS verification)
MAILGUN_DOMAIN=sandbox123.mailgun.org

# Mailgun Region: 'us' (default) or 'eu' (for EU data residency)
MAILGUN_REGION=us

# From email address (defaults to postmaster@{domain})
MAILGUN_FROM_EMAIL=CrecheBooks <postmaster@yourdomain.com>

# Mailgun Webhook Signing Key (for delivery tracking webhooks)
# Get from: Mailgun Dashboard > Webhooks > Signing Key (or Sending > Webhooks)
# REQUIRED for receiving delivery status updates (bounces, opens, clicks, etc.)
# Webhook endpoint: POST /api/v1/webhooks/mailgun
MAILGUN_WEBHOOK_SIGNING_KEY=

# ======================================================================
# SMS Gateway Configuration (TASK-NOTIF-002)
# Options: africastalking (production), mock (development)
SMS_GATEWAY=mock
SMS_SENDER_ID=CrecheBooks

# Africa's Talking SMS Gateway (South Africa)
# Register at: https://africastalking.com
# Use 'sandbox' username for testing, your actual username for production
AFRICASTALKING_API_KEY=your_africastalking_api_key_here
AFRICASTALKING_USERNAME=sandbox

# SARS eFiling API Configuration (TASK-SARS-019)
# Register at: https://www.sarsefiling.co.za/
# For production: set SARS_SANDBOX=false and use production credentials
SARS_SANDBOX=true
SARS_CLIENT_ID=your_sars_client_id_here
SARS_CLIENT_SECRET=your_sars_client_secret_here

# ======================================================================
# Webhook Idempotency Configuration (TASK-INFRA-006)
# Prevents duplicate processing of retried webhooks
# ======================================================================

# Default TTL for idempotency keys in seconds
# Should be longer than the longest webhook retry window (e.g., SendGrid: 72h)
# Default: 86400 (24 hours)
IDEMPOTENCY_TTL=86400

# ======================================================================
# WEBHOOK SECRETS (TASK-SEC-006)
# CRITICAL: These are REQUIRED if webhooks are enabled - NO EXCEPTIONS
# Webhooks will FAIL FAST if secrets are not configured
# ======================================================================

# SendGrid Email Webhook Secret
# Get from: SendGrid Dashboard > Settings > Mail Settings > Event Webhook
# For development: Use test mode webhook secret from SendGrid sandbox
# REQUIRED if email delivery tracking webhooks are enabled
SENDGRID_WEBHOOK_KEY=your_sendgrid_webhook_signing_secret_here

# ======================================================================
# WhatsApp Business API Configuration (TASK-INT-005)
# Register at: https://developers.facebook.com/
# ======================================================================

# REQUIRED: App Secret from Meta Developer Console (for webhook signature verification)
# Find at: Meta Developer Portal > App > Settings > Basic > App Secret
# SECURITY: This is used for HMAC-SHA256 verification of X-Hub-Signature-256 header
# WARNING: This is DIFFERENT from the Verify Token - do not confuse them!
WHATSAPP_APP_SECRET=your_meta_app_secret_here

# REQUIRED: Custom Verify Token for webhook URL verification challenge
# This is a custom string YOU create and configure in Meta Developer Portal
# Used only for the initial webhook URL verification (GET request with hub.challenge)
WHATSAPP_WEBHOOK_VERIFY_TOKEN=your_custom_verification_token_here

# REQUIRED: Access Token for API calls
# Get from: Meta Developer Portal > App > WhatsApp > API Setup > Permanent Token
WHATSAPP_ACCESS_TOKEN=

# REQUIRED: Phone Number ID and Business Account ID
# Get from: Meta Developer Portal > App > WhatsApp > API Setup
WHATSAPP_PHONE_NUMBER_ID=
WHATSAPP_BUSINESS_ACCOUNT_ID=

# ======================================================================
# Twilio WhatsApp Configuration (TASK-WA-007)
# Alternative to Meta's Cloud API - simpler setup, no template approval
# Register at: https://www.twilio.com/
# ======================================================================

# WhatsApp Provider: 'meta' (default) or 'twilio'
WHATSAPP_PROVIDER=twilio

# REQUIRED for Twilio: Account credentials
# Get from: Twilio Console > Account Dashboard > Account Info
TWILIO_ACCOUNT_SID=
TWILIO_AUTH_TOKEN=

# REQUIRED for Twilio: WhatsApp-enabled phone number
# Sandbox: +14155238886 (for testing)
# Production: Your Twilio WhatsApp number
TWILIO_WHATSAPP_NUMBER=+14155238886

# OPTIONAL: Status callback URL for delivery receipts
# Set to your API endpoint, e.g., https://yourdomain.com/api/webhooks/twilio/status
TWILIO_STATUS_CALLBACK_URL=

# Stripe Webhook Secret (if payment integration enabled)
# Get from: Stripe Dashboard > Developers > Webhooks > Signing secret
# For development: Use `stripe listen --forward-to localhost:3000/webhooks/stripe` to get test secret
# STRIPE_WEBHOOK_SECRET=whsec_your_stripe_webhook_secret_here

# Xero Webhook Secret (if Xero integration enabled)
# Get from: Xero Developer Portal > Webhooks > Signing key
# XERO_WEBHOOK_SECRET=your_xero_webhook_signing_key_here

# ======================================================================
# CORS Configuration (TASK-SEC-005)
# CRITICAL: REQUIRED in production - Application will FAIL TO START
# ======================================================================

# Comma-separated list of allowed origins for cross-origin requests
# Example production: https://app.crechebooks.co.za,https://www.crechebooks.co.za
# Development defaults: http://localhost:3000,http://localhost:3001
CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:3001

# Optional CORS settings (defaults shown below)
# CORS_ALLOWED_METHODS=GET,POST,PUT,DELETE,PATCH,OPTIONS
# CORS_ALLOWED_HEADERS=Content-Type,Authorization,X-CSRF-Token,X-Requested-With,Accept,Origin
# CORS_CREDENTIALS=true
# CORS_MAX_AGE=86400

# ======================================================================
# Reconciliation Tolerance Configuration (TASK-RECON-003)
# All monetary values are in CENTS. Defaults shown below.
# ======================================================================

# Amount matching tolerance for individual transaction matching (in cents)
# Default: 1 (1 cent - allows for minor rounding differences)
# RECONCILIATION_AMOUNT_TOLERANCE=1

# Balance validation tolerance for closing balance reconciliation (in cents)
# Default: 100 (R1.00 - accounts for bank fees, interest, etc.)
# RECONCILIATION_BALANCE_TOLERANCE=100

# Bank fee tolerance - maximum expected bank fee (in cents)
# Default: 500 (R5.00 - typical SA bank fee range)
# RECONCILIATION_BANK_FEE_TOLERANCE=500

# Date tolerance for matching transactions with date differences (in days)
# Default: 1 (1 day - accounts for processing delays)
# RECONCILIATION_DATE_TOLERANCE=1

# Percentage tolerance for large amounts (decimal, e.g., 0.005 = 0.5%)
# Applied when amount exceeds RECONCILIATION_LARGE_AMOUNT_THRESHOLD
# Default: 0.005 (0.5%)
# RECONCILIATION_PERCENTAGE_TOLERANCE=0.005

# Large amount threshold (in cents) - amounts above this use percentage tolerance
# Default: 1000000 (R10,000)
# RECONCILIATION_LARGE_AMOUNT_THRESHOLD=1000000

# Description similarity threshold for matching (0-1)
# Default: 0.7 (70% similarity)
# RECONCILIATION_DESCRIPTION_SIMILARITY=0.7

# ======================================================================
# Body Parser Limits (TASK-INFRA-008)
# Configure maximum request payload sizes to prevent memory exhaustion
# ======================================================================

# Maximum JSON payload size (default: 10mb)
# Applies to Content-Type: application/json requests
# BODY_LIMIT_JSON=10mb

# Maximum URL-encoded payload size (default: 10mb)
# Applies to Content-Type: application/x-www-form-urlencoded requests
# BODY_LIMIT_URLENCODED=10mb

# Maximum raw body size for webhooks (default: 5mb)
# Applies to raw body parsing for webhook signature verification
# BODY_LIMIT_RAW=5mb
