name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - production
          - staging
      services:
        description: 'Services to deploy'
        required: false
        type: choice
        default: 'all'
        options:
          - all
          - api
          - web

env:
  NODE_VERSION: '20.x'
  PNPM_VERSION: '9.15.0'

jobs:
  # Deploy API Service
  deploy-api:
    name: Deploy API to Railway
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.services != 'web' }}
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ vars.API_URL || 'https://api.elleelephant.co.za' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Link Railway Project
        run: |
          echo "üîó Linking to Railway project..."
          railway link ${{ secrets.RAILWAY_PROJECT_ID }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Deploy API to Railway
        run: |
          echo "üöÄ Deploying API service..."
          railway up --service crechebooks-api --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting for API deployment to complete..."
          sleep 30

      - name: Run database migrations
        run: |
          echo "üîÑ Running database migrations..."
          railway run --service crechebooks-api npx prisma migrate deploy || echo "Migration skipped or already up to date"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true

      - name: Verify API deployment
        run: |
          echo "‚úÖ API deployment initiated"
          echo "Service: crechebooks-api"
          echo "Commit: ${{ github.sha }}"

  # Deploy Web Service
  deploy-web:
    name: Deploy Web to Railway
    runs-on: ubuntu-latest
    if: ${{ always() && github.event.inputs.services != 'api' && (needs.deploy-api.result == 'success' || needs.deploy-api.result == 'skipped') }}
    needs: [deploy-api]
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ vars.WEB_URL || 'https://elleelephant.co.za' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Link Railway Project
        run: |
          echo "üîó Linking to Railway project..."
          railway link ${{ secrets.RAILWAY_PROJECT_ID }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Deploy Web to Railway
        run: |
          echo "üöÄ Deploying Web service..."
          railway up --service crechebooks-web --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Verify Web deployment
        run: |
          echo "‚úÖ Web deployment initiated"
          echo "Service: crechebooks-web"
          echo "Commit: ${{ github.sha }}"

  # Deployment Summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-web]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "üìä Deployment Summary"
          echo "====================="
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "Commit: ${{ github.sha }}"
          echo "Deployed by: ${{ github.actor }}"
          echo ""
          echo "API Status: ${{ needs.deploy-api.result }}"
          echo "Web Status: ${{ needs.deploy-web.result }}"
          echo ""
          if [ "${{ needs.deploy-api.result }}" == "success" ] && [ "${{ needs.deploy-web.result }}" == "success" ]; then
            echo "‚úÖ All services deployed successfully"
          else
            echo "‚ö†Ô∏è Some services may have failed - check Railway dashboard"
          fi
