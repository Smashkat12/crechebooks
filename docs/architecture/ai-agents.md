# CrecheBooks AI Agents Architecture

**Last Updated:** 2026-02-03
**Status:** Production Ready
**Agents:** 11 specialized agents with hybrid decision making
**Generated By:** CrecheBooks Documentation Swarm

## Overview

CrecheBooks implements a sophisticated multi-agent AI system for financial decision-making. All agents use a **hybrid approach** combining heuristic rules, LLM reasoning, and vector similarity search.

## System Architecture

```mermaid
graph TB
    subgraph "Orchestrator Layer"
        Orch["üéØ Orchestrator Agent<br/>(L1 Coordination)"]
    end

    subgraph "Specialist Agents"
        Cat["üìä Transaction Categorizer<br/>(L3 Autonomy)"]
        Pay["üí≥ Payment Matcher<br/>(L3 Autonomy)"]
        Sars["üèõÔ∏è SARS Agent<br/>(L2 Review)"]
        Val["‚úì Extraction Validator<br/>(L3 Autonomy)"]
        Rep["üìà Report Synthesis<br/>(SDK-Enhanced)"]
        Conv["üí¨ Conversational<br/>(L3 Autonomy)"]
    end

    subgraph "Infrastructure"
        Mem["üß† Agent Memory"]
        Audit["üìù Audit Trail"]
        Roll["üîÑ Rollout Framework"]
        SDK["ü§ñ SDK Foundation"]
    end

    Orch --> Cat
    Orch --> Pay
    Orch --> Sars
    Orch --> Val
    Orch --> Rep
    Orch --> Conv

    Cat --> Mem
    Pay --> Mem
    Sars --> Mem
    Val --> Mem

    Cat --> Audit
    Pay --> Audit
    Sars --> Audit

    Cat --> Roll
    Pay --> Roll
```

---

## Autonomy Levels

| Level | Name | Behavior | Use Case |
|-------|------|----------|----------|
| **L1** | Observer | Log only, coordinate routing | Orchestration |
| **L2** | Collaborator | Draft for human review | SARS submissions |
| **L3** | Autonomous | Auto-apply if ‚â•80% confidence | Categorization, Matching |

---

## Agent Catalog

### 1. Orchestrator Agent (TASK-AGENT-005)

**Purpose:** Routes workflows to specialist agents based on task type.

**Workflow Types:**
- `CATEGORIZE` ‚Üí Transaction Categorizer
- `MATCH` ‚Üí Payment Matcher
- `TAX` ‚Üí SARS Agent
- `VALIDATE` ‚Üí Extraction Validator
- `REPORT` ‚Üí Report Synthesis
- `QUERY` ‚Üí Conversational Agent

### 2. Transaction Categorizer (TASK-AGENT-002)

**Purpose:** Categorizes bank transactions to GL accounts.

**Autonomy Level:** L3 (Auto-apply ‚â•80% confidence)

**Decision Flow:**
1. Pattern match (‚â•80% confidence) ‚Üí use pattern
2. Ruvector semantic search (cosine ‚â•0.85) ‚Üí boost confidence
3. LLM inference via SDK ‚Üí resolve ambiguity
4. Historical match ‚Üí fallback
5. Default codes (4100 credit / 8100 debit) ‚Üí last resort

**Thresholds:**

| Confidence | Action |
|------------|--------|
| ‚â•80% | AUTO_APPLY |
| 50-79% | REVIEW_REQUIRED |
| <50% | ESCALATE |

### 3. Payment Matcher (TASK-AGENT-003)

**Purpose:** Matches bank payments to outstanding invoices.

**Autonomy Level:** L3 (Auto-apply if single match ‚â•80%)

**Scoring Algorithm (0-100 points):**

| Factor | Weight | Criteria |
|--------|--------|----------|
| Reference Match | 0-40 | exact=40, contains=30, suffix=15 |
| Amount Match | 0-40 | exact=40, within 1%=35, within 5%=25 |
| Name Similarity | 0-20 | exact=20, >80%=15, >60%=10 |

**Conditions:**
- Single match ‚â•80%: AUTO_APPLY
- Multiple matches ‚â•80%: REVIEW_REQUIRED (ambiguous)
- Amount >R50,000: REVIEW_REQUIRED (high-value override)

### 4. SARS Agent (TASK-AGENT-004)

**Purpose:** Calculates tax obligations and generates SARS submissions.

**Autonomy Level:** L2 (ALWAYS drafts for human review)

**Supported Calculations:**
- PAYE (Pay As You Earn)
- UIF (Unemployment Insurance Fund)
- EMP201 (Monthly reconciliation)
- VAT201 (Quarterly VAT)

**Critical Rule:** SARS submissions NEVER auto-apply. All require human approval.

### 5. Extraction Validator (TASK-AGENT-006)

**Purpose:** Validates PDF bank statement extraction quality.

**Autonomy Level:** L3 (Auto-accept ‚â•90% confidence)

**Validation Checks:**
- Balance reconciliation: opening + transactions = closing
- Amount sanity: detects unrealistic amounts
- OCR error patterns: common OCR mistakes (1‚Üíl, 0‚ÜíO)
- Duplicate detection

### 6. Report Synthesis Agent (TASK-REPORTS-001)

**Purpose:** Generates AI-powered financial insights.

**Report Types:**
- Income Statement Analysis
- Balance Sheet Analysis
- Aged Receivables Analysis
- Aged Payables Analysis
- Anomaly Detection
- Trend Analysis

### 7. Conversational Agent (TASK-SDK-008)

**Purpose:** Natural language interface for financial queries.

**Query Complexity Routing:**

| Complexity | Example | Model |
|------------|---------|-------|
| Simple | "What's my balance?" | Haiku |
| Moderate | "Show January transactions" | Sonnet |
| Complex | "Compare MoM profitability" | Opus |

---

## Memory & Learning Systems

### Architecture

```mermaid
graph TD
    MemSvc["Agent Memory Service<br/>(Non-blocking dual-write)"]

    MemSvc --> AgentDB["AgentDB<br/>(Fast decisions)"]
    MemSvc --> Prisma["Prisma<br/>(Persistence)"]
    MemSvc --> Ruvector["Ruvector<br/>(384-dim vectors)"]

    Ruvector --> PatternLearner["Pattern Learner"]
    Prisma --> FeedbackLoop["Feedback Loop"]
```

### Memory Operations

```typescript
// Store decision
await memory.storeDecision({
  tenantId: string,
  agentType: 'categorizer' | 'matcher' | 'validator' | 'sars',
  decision: DecisionResult,
  inputHash: string,
  metadata: Record<string, unknown>
});

// Record correction (learning)
await memory.recordCorrection({
  decisionId: string,
  correction: unknown,
  reasoningChain: string
});

// Retrieve similar decisions
const similar = await memory.getSimilarDecisions({
  query: string,
  tenantId: string,
  agentType: string,
  limit: number,
  threshold: number // Cosine similarity
});
```

### Learning Feedback Loop

```
User Correction ‚Üí Record to Correction Table
        ‚Üì
Pattern Learner Analysis
‚îú‚îÄ Compare original to correction
‚îú‚îÄ Compute error delta
‚îú‚îÄ Update accuracy metrics
‚îî‚îÄ Adjust confidence weights
        ‚Üì
Next Agent Run
‚îú‚îÄ Query similar decisions
‚îú‚îÄ Apply learned patterns
‚îî‚îÄ Use updated weights
```

---

## Hybrid Scoring

All agents use a weighted combination of heuristic and LLM scores:

```
Final Score = (LLM Confidence √ó 0.6) + (Heuristic Confidence √ó 0.4)
```

**Safety Floor:** Minimum 20% heuristic weight for financial operations.

**Fallback:** If SDK unavailable, 100% heuristic scoring.

---

## Audit Trail

All agent decisions are logged to the `AgentDecision` table:

```typescript
interface LogDecisionParams {
  tenantId: string;
  agentType: string;
  decision: string; // 'match' | 'categorize' | 'escalate'
  confidence: number;
  autoApplied: boolean;
  source: string; // 'deterministic' | 'sdk' | 'historical'
  reasoning: string;
  durationMs: number;
  transactionId?: string;
  invoiceId?: string;
  details: Record<string, unknown>;
}
```

**NO PII stored** - only IDs, codes, confidence scores, and metadata.

---

## Performance Characteristics

| Operation | Latency | Throughput |
|-----------|---------|------------|
| Categorization | 50-200ms | ~200 tx/sec |
| Payment Matching | 30-150ms | ~300 tx/sec |
| Validation | 20-100ms | ~500 tx/sec |
| Audit Logging | <1ms | ~10k logs/sec |
| Vector Search | 5-50ms | ~1000/sec |
| Report Synthesis | 1-5s | ~10/min |

---

## Implementation Status

| Agent | Heuristic | SDK | Memory | Audit | Status |
|-------|-----------|-----|--------|-------|--------|
| Orchestrator | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | üü¢ FULL |
| Categorizer | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | üü¢ FULL |
| Matcher | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | üü¢ FULL |
| SARS | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | üü¢ FULL |
| Validator | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | üü¢ FULL |
| Report Synthesis | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | üü¢ FULL |
| Conversational | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | üü¢ FULL |

**Partial Implementation:**
- SONA optimization (Stub scorer, needs agentic-flow package)
- GNN pattern analysis (Interface ready, adapter available)

---

## File Locations

```
apps/api/src/agents/
‚îú‚îÄ‚îÄ orchestrator/           # Workflow routing
‚îú‚îÄ‚îÄ transaction-categorizer/ # GL categorization
‚îú‚îÄ‚îÄ payment-matcher/        # Invoice matching
‚îú‚îÄ‚îÄ sars-agent/             # Tax calculations
‚îú‚îÄ‚îÄ extraction-validator/   # PDF validation
‚îú‚îÄ‚îÄ report-synthesis/       # AI reports
‚îú‚îÄ‚îÄ conversational/         # NL queries
‚îú‚îÄ‚îÄ memory/                 # Learning storage
‚îú‚îÄ‚îÄ audit/                  # Decision logging
‚îú‚îÄ‚îÄ rollout/                # A/B testing
‚îî‚îÄ‚îÄ sdk/                    # LLM integration
```

---

*Generated by CrecheBooks Documentation Swarm*
