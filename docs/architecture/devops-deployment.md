# CrecheBooks DevOps & Deployment

**Last Updated:** 2026-02-03
**Status:** Production Ready
**Generated By:** CrecheBooks Documentation Swarm

## Architecture Overview

```mermaid
graph TB
    subgraph "Version Control"
        GH["GitHub Repository"]
    end

    subgraph "CI/CD Pipeline (GitHub Actions)"
        LINT["Lint & Type Check"]
        TEST_API["Test API (4 shards)"]
        TEST_WEB["Test Web"]
        BUILD["Build Applications"]
    end

    subgraph "Production (Railway)"
        API_PROD["API Container :3000"]
        WEB_PROD["Web Container :3000"]
        PG["PostgreSQL 16 + pgvector"]
        REDIS["Redis 7"]
    end

    subgraph "Development (Local)"
        DEV_API["Dev API :3000"]
        DEV_WEB["Dev Web :3001"]
        DEV_PG["PostgreSQL :5433"]
        DEV_REDIS["Redis :6379"]
    end

    GH --> LINT
    LINT --> TEST_API
    LINT --> TEST_WEB
    TEST_API --> BUILD
    TEST_WEB --> BUILD

    API_PROD --> PG
    API_PROD --> REDIS
    WEB_PROD --> API_PROD

    DEV_API --> DEV_PG
    DEV_API --> DEV_REDIS
```

## Technology Stack

| Component | Technology | Version |
|-----------|-----------|---------|
| Runtime | Node.js | 20.x |
| Package Manager | pnpm | 9.15.0 |
| Database | PostgreSQL | 16 (pgvector) |
| Cache/Queue | Redis | 7-alpine |
| API Framework | NestJS | 11 |
| Frontend | Next.js | 15 |
| Deployment | Railway | PaaS |
| CI/CD | GitHub Actions | - |

---

## CI/CD Pipeline

### GitHub Actions Workflow

**Triggered on:** `push main` | `pull_request main`

| Job | Duration | Description |
|-----|----------|-------------|
| lint | ~2-3 min | ESLint, TypeScript type check |
| test-api | ~12-15 min | Jest with 4 shards, database isolation |
| test-web | ~3-4 min | Jest for React components |
| build | ~5-8 min | Build API/Web, upload artifacts |
| docker-build | ~8-10 min | PR only, cached layers |

### Test Environment

```yaml
Services:
  - PostgreSQL: pgvector/pgvector:pg16 (port 5432)
  - Redis: redis:7-alpine (port 6379)

Environment:
  - DATABASE_URL: postgresql://test:test@localhost:5432/crechebooks_test
  - NODE_ENV: test
```

---

## Development Setup

### Quick Start

```bash
./scripts/dev-start.sh
```

This script:
1. Checks Docker, pnpm, Node.js versions
2. Starts PostgreSQL 16 + Redis 7 via Docker
3. Installs dependencies
4. Generates Prisma client
5. Runs migrations
6. Starts API (:3000) and Web (:3001)

### Manual Setup

```bash
# Start infrastructure
docker compose -f docker-compose.dev.yml up -d

# Install and setup
pnpm install
pnpm prisma:generate
pnpm prisma:migrate

# Start dev servers
pnpm dev
```

### Docker Compose (Dev)

```yaml
postgres:
  image: pgvector/pgvector:pg16
  port: 5433:5432
  healthcheck: pg_isready

redis:
  image: redis:7-alpine
  port: 6379:6379
  healthcheck: redis-cli ping
```

---

## Docker Configuration

### Multi-Stage Build (3 stages)

1. **deps** - Install system dependencies, pnpm, lockfile
2. **builder** - Build application, generate Prisma client
3. **runner** - Production image, non-root user, health checks

### API Dockerfile Features

- Non-root user: `nestjs` (UID 1001)
- Prisma client generation
- Health check: `GET /health`
- Entrypoint: `dumb-init` for signal handling
- Startup: `start.sh` (runs migrations)

### Web Dockerfile Features

- Non-root user: `nextjs` (UID 1001)
- Next.js standalone output
- Health check: `GET /health`
- Port flexibility via `PORT` env var

---

## Railway Deployment

### Prerequisites

```bash
npm install -g @railway/cli
railway login
railway link
```

### Deployment Script

```bash
./scripts/deploy-railway.sh
```

Interactive menu:
1. Deploy API only
2. Deploy Web only
3. Deploy both
4. Create new project
5. Link to existing project

### Required Environment Variables

```bash
# Core
NODE_ENV=production
ENCRYPTION_KEY=<openssl rand -base64 32>
JWT_SECRET=<openssl rand -base64 32>

# Database (auto-set by Railway)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# Redis (auto-set by Railway)
REDIS_HOST=${{Redis.REDIS_HOST}}
REDIS_PORT=${{Redis.REDIS_PORT}}

# CORS
CORS_ALLOWED_ORIGINS=https://your-domain.com

# API URL for Web
NEXT_PUBLIC_API_URL=https://api.your-domain.com
```

---

## Scripts Reference

| Script | Purpose | Usage |
|--------|---------|-------|
| `dev-start.sh` | Quick dev setup | `./scripts/dev-start.sh` |
| `docker-build.sh` | Build Docker images | `./scripts/docker-build.sh [api\|web\|all]` |
| `deploy-railway.sh` | Deploy to Railway | `./scripts/deploy-railway.sh` |
| `setup-local-env.sh` | Generate .env files | `./scripts/setup-local-env.sh` |
| `generate-secrets.sh` | Display secret template | `./scripts/generate-secrets.sh` |

---

## Monorepo Structure

```
crechebooks/
├── apps/
│   ├── api/           # @crechebooks/api (NestJS)
│   ├── web/           # @crechebooks/web (Next.js)
│   └── cli/           # @crechebooks/cli
├── packages/
│   └── types/         # @crechebooks/types
├── scripts/           # DevOps scripts
├── .github/workflows/ # CI/CD
├── docker-compose.yml # Production
└── docker-compose.dev.yml # Development
```

### Root Package Scripts

```bash
pnpm dev              # Start all dev servers
pnpm build            # Build all packages
pnpm test             # Run all tests
pnpm lint             # Lint all packages
pnpm prisma:migrate   # Run migrations
pnpm docker:build     # Build Docker images
pnpm deploy           # Deploy to Railway
```

---

## Health Checks

### API Health Endpoint

```
GET /health

Response:
{
  "status": "ok",
  "database": "connected",
  "redis": "connected"
}
```

### Docker Health Check

```dockerfile
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD wget --spider http://localhost:${PORT:-3000}/health
```

---

## Troubleshooting

### Common Issues

| Issue | Solution |
|-------|----------|
| Port 3000 in use | `lsof -i :3000 && kill -9 <PID>` |
| Database connection failed | `pnpm dev:infra:reset` |
| Prisma errors | `pnpm prisma:generate && pnpm prisma:migrate` |
| Docker build fails | `docker system prune -a` |
| Railway deploy fails | `railway login && railway link` |

### Debug Commands

```bash
# Check Docker
docker ps | grep crechebooks
docker logs -f crechebooks-api

# Check database
pnpm prisma:studio

# Check Railway
railway logs --service api
railway variables
```

---

## Deployment Checklist

### Pre-Deployment
- [ ] CI pipeline passes
- [ ] Migrations tested locally
- [ ] Environment variables validated
- [ ] Docker images built and tested

### Railway Deployment
- [ ] PostgreSQL service added
- [ ] Redis service added
- [ ] All env vars set
- [ ] API deployed
- [ ] Web deployed
- [ ] Health checks passing

### Post-Deployment
- [ ] Monitor logs for errors
- [ ] Test authentication flow
- [ ] Verify integrations
- [ ] Check audit logs

---

*Generated by CrecheBooks Documentation Swarm*
