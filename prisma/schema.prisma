// CrecheBooks Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum TaxStatus {
  VAT_REGISTERED
  NOT_REGISTERED
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum UserRole {
  OWNER
  ADMIN
  VIEWER
  ACCOUNTANT
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  CATEGORIZE
  MATCH
  RECONCILE
  SUBMIT
}

// ============================================
// MODELS
// ============================================

model Tenant {
  id                   String             @id @default(uuid())
  name                 String             @db.VarChar(200)
  tradingName          String?            @map("trading_name") @db.VarChar(200)
  registrationNumber   String?            @map("registration_number") @db.VarChar(50)
  vatNumber            String?            @map("vat_number") @db.VarChar(20)
  taxStatus            TaxStatus          @default(NOT_REGISTERED) @map("tax_status")
  addressLine1         String             @map("address_line1") @db.VarChar(200)
  addressLine2         String?            @map("address_line2") @db.VarChar(200)
  city                 String             @db.VarChar(100)
  province             String             @db.VarChar(50)
  postalCode           String             @map("postal_code") @db.VarChar(10)
  phone                String             @db.VarChar(20)
  email                String             @unique @db.VarChar(255)
  xeroTenantId         String?            @unique @map("xero_tenant_id") @db.VarChar(50)
  subscriptionStatus   SubscriptionStatus @default(TRIAL) @map("subscription_status")
  invoiceDayOfMonth    Int                @default(1) @map("invoice_day_of_month")
  invoiceDueDays       Int                @default(7) @map("invoice_due_days")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  users                User[]

  @@map("tenants")
}

model User {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  auth0Id     String    @unique @map("auth0_id")
  email       String
  name        String
  role        UserRole
  isActive    Boolean   @default(true) @map("is_active")
  lastLoginAt DateTime? @map("last_login_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([auth0Id])
  @@map("users")
}

model AuditLog {
  id             String      @id @default(uuid())
  tenantId       String      @map("tenant_id")
  userId         String?     @map("user_id")
  agentId        String?     @map("agent_id")
  entityType     String      @map("entity_type")
  entityId       String      @map("entity_id")
  action         AuditAction
  beforeValue    Json?       @map("before_value")
  afterValue     Json?       @map("after_value")
  changeSummary  String?     @map("change_summary")
  ipAddress      String?     @map("ip_address") @db.VarChar(45)
  userAgent      String?     @map("user_agent")
  createdAt      DateTime    @default(now()) @map("created_at")

  // NOTE: No @updatedAt - this table is IMMUTABLE
  // NOTE: No foreign keys - intentional for immutability

  @@index([tenantId, entityType, entityId])
  @@index([tenantId, createdAt])
  @@index([userId, createdAt])
  @@map("audit_logs")
}
