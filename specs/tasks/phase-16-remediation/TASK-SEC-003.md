# TASK-SEC-003: Migrate CSRF State to Redis

```xml
<task_spec id="TASK-SEC-003" version="1.0">
  <metadata>
    <title>Migrate CSRF State to Redis</title>
    <priority>CRITICAL</priority>
    <estimated_tokens>4500</estimated_tokens>
    <domain>security</domain>
    <phase>16</phase>
    <status>DONE</status>
    <depends_on>none</depends_on>
  </metadata>

  <context>
    <background>
      In-memory CSRF token storage fails in distributed environments. When running
      multiple API instances behind a load balancer, tokens generated by one instance
      cannot be validated by another, causing legitimate requests to fail and creating
      security gaps where attackers might exploit race conditions.
    </background>
    <current_state>
      CSRF tokens stored in application memory:
      - Tokens lost on server restart
      - Tokens not shared across multiple instances
      - Load-balanced requests randomly fail CSRF validation
      - Potential for CSRF bypass in multi-instance deployments
    </current_state>
    <target_state>
      Redis-backed CSRF token storage:
      - Tokens persisted across server restarts
      - Tokens shared across all application instances
      - Consistent CSRF validation regardless of which instance handles request
      - Proper token expiration with Redis TTL
      - Graceful fallback if Redis temporarily unavailable
    </target_state>
  </context>

  <scope>
    <files_to_modify>
      <file path="apps/api/src/auth/auth.service.ts" action="modify">
        Update CSRF token generation to use Redis storage
      </file>
      <file path="apps/api/src/auth/csrf.guard.ts" action="modify">
        Update CSRF validation to read from Redis
      </file>
      <file path="apps/api/src/auth/auth.module.ts" action="modify">
        Add Redis module dependency for CSRF storage
      </file>
      <file path="apps/api/src/app.module.ts" action="modify">
        Configure Redis connection for auth module
      </file>
    </files_to_modify>
    <files_to_create>
      <file path="apps/api/src/auth/csrf-store.service.ts">
        Dedicated service for CSRF token storage operations
      </file>
      <file path="apps/api/src/auth/csrf-store.interface.ts">
        Interface for CSRF store to allow different implementations
      </file>
      <file path="apps/api/src/common/redis/redis.module.ts">
        Shared Redis module if not already existing
      </file>
    </files_to_create>
  </scope>

  <implementation>
    <step order="1">
      Set up Redis connection configuration:
      - Add REDIS_URL environment variable support
      - Configure Redis client with proper connection pooling
      - Add health check for Redis connection
    </step>
    <step order="2">
      Create CSRF store interface:
      - Define ICsrfStore interface with store, validate, invalidate methods
      - Include token metadata (userId, createdAt, expiresAt)
      - Support both sync and async operations
    </step>
    <step order="3">
      Implement Redis-backed CSRF store service:
      - Implement ICsrfStore using Redis client
      - Use CSRF:{userId}:{tokenId} key pattern
      - Set TTL matching token expiration (default 1 hour)
      - Include proper error handling for Redis failures
    </step>
    <step order="4">
      Update auth.service.ts for CSRF generation:
      - Inject CsrfStoreService
      - Generate cryptographically secure token (crypto.randomBytes)
      - Store token in Redis with user association
      - Return token to client in response/cookie
    </step>
    <step order="5">
      Update csrf.guard.ts for validation:
      - Inject CsrfStoreService
      - Retrieve and validate token from Redis
      - Implement constant-time comparison to prevent timing attacks
      - Invalidate token after successful use (if single-use policy)
    </step>
    <step order="6">
      Implement graceful degradation:
      - Add circuit breaker for Redis failures
      - Log Redis connection issues with appropriate severity
      - Consider fallback behavior (fail secure vs. fail open decision)
    </step>
    <step order="7">
      Add monitoring and metrics:
      - Track CSRF validation success/failure rates
      - Monitor Redis connection health
      - Alert on unusual CSRF failure patterns
    </step>
  </implementation>

  <verification>
    <test_command>npm run test -- --grep "csrf" && npm run test:e2e -- --grep "csrf"</test_command>
    <acceptance_criteria>
      <criterion>CSRF tokens successfully stored in Redis</criterion>
      <criterion>CSRF validation works across multiple API instances</criterion>
      <criterion>Tokens expire correctly using Redis TTL</criterion>
      <criterion>Server restart does not invalidate valid tokens</criterion>
      <criterion>Proper error handling when Redis unavailable</criterion>
      <criterion>No CSRF validation failures for legitimate requests</criterion>
      <criterion>All existing CSRF tests pass with Redis backend</criterion>
    </acceptance_criteria>
  </verification>

  <definition_of_done>
    <item>Redis-backed CSRF store service implemented</item>
    <item>auth.service.ts updated for Redis token storage</item>
    <item>csrf.guard.ts updated for Redis token validation</item>
    <item>Redis connection configuration added</item>
    <item>Graceful degradation implemented for Redis failures</item>
    <item>Unit tests for CSRF store service passing</item>
    <item>Integration tests with Redis passing</item>
    <item>Load test confirming multi-instance compatibility</item>
    <item>Documentation updated with Redis requirements</item>
  </definition_of_done>
</task_spec>
```
